# API Authentication - X√°c th·ª±c ng∆∞·ªùi d√πng

## üìã M·ª•c l·ª•c
- [T·ªïng quan](#t·ªïng-quan)
- [Base URL](#base-url)
- [Authentication](#authentication)
- [Danh s√°ch API](#danh-s√°ch-api)
- [Chi ti·∫øt t·ª´ng API](#chi-ti·∫øt-t·ª´ng-api)
- [Enums v√† Constants](#enums-v√†-constants)
- [Error Codes](#error-codes)
- [V√≠ d·ª• s·ª≠ d·ª•ng](#v√≠-d·ª•-s·ª≠-d·ª•ng)

---

## üéØ T·ªïng quan

Module Authentication cung c·∫•p c√°c ch·ª©c nƒÉng x√°c th·ª±c v√† qu·∫£n l√Ω t√†i kho·∫£n ng∆∞·ªùi d√πng trong h·ªá th·ªëng EV Co-ownership, bao g·ªìm:
- ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω
- Refresh token
- Qu√™n m·∫≠t kh·∫©u v√† ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u
- X√°c minh gi·∫•y ph√©p l√°i xe (basic)

**L∆∞u √Ω quan tr·ªçng:**
- JWT Token ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ x√°c th·ª±c
- Refresh Token ƒë·ªÉ duy tr√¨ phi√™n ƒëƒÉng nh·∫≠p
- H·ªá th·ªëng OTP qua email cho vi·ªác ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u

---

## üîó Base URL

```
http://localhost:5215/api/auth
```

Trong production: `https://your-domain.com/api/auth`

---

## üîê Authentication

H·∫ßu h·∫øt c√°c API y√™u c·∫ßu JWT Bearer Token trong header:

```http
Authorization: Bearer {access_token}
```

**Ngo·∫°i l·ªá (kh√¥ng c·∫ßn token):**
- POST `/login`
- POST `/register`
- POST `/forgot-password`
- PATCH `/reset-password`

---

## üìë Danh s√°ch API

| STT | Method | Endpoint | M√¥ t·∫£ | Auth Required |
|-----|--------|----------|-------|---------------|
| 1 | POST | `/login` | ƒêƒÉng nh·∫≠p h·ªá th·ªëng | ‚ùå |
| 2 | POST | `/register` | ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi | ‚ùå |
| 3 | POST | `/refresh-token` | L√†m m·ªõi access token | ‚ùå |
| 4 | POST | `/forgot-password` | G·ª≠i OTP qua email ƒë·ªÉ reset password | ‚ùå |
| 5 | PATCH | `/reset-password` | ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u b·∫±ng OTP | ‚ùå |
| 6 | POST | `/verify-license` | X√°c minh gi·∫•y ph√©p l√°i xe (basic) | ‚ùå |
| 7 | GET | `/test/get-forgot-password-otp` | [DEV] L·∫•y OTP test | ‚ùå |

---

## üìñ Chi ti·∫øt t·ª´ng API

### 1. üîë ƒêƒÉng nh·∫≠p - POST `/login`

**M√¥ t·∫£:** X√°c th·ª±c ng∆∞·ªùi d√πng v·ªõi email v√† password, tr·∫£ v·ªÅ access token v√† refresh token.

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "P@ssw0rd123"
}
```

**Request Schema:**
| Field | Type | Required | Validation |
|-------|------|----------|------------|
| email | string | ‚úÖ | Email format, max 100 chars |
| password | string | ‚úÖ | Min 8 chars |

**Response 200 - Th√†nh c√¥ng:**
```json
{
  "statusCode": 200,
  "message": "LOGIN_SUCCESS",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 3600,
    "user": {
      "userId": 1,
      "email": "user@example.com",
      "firstName": "Nguyen",
      "lastName": "Van A",
      "role": "CoOwner",
      "status": "Active"
    }
  }
}
```

**Response 400 - Email/Password sai:**
```json
{
  "statusCode": 400,
  "message": "INVALID_EMAIL_OR_PASSWORD",
  "data": null,
  "errors": null
}
```

**Response 403 - T√†i kho·∫£n b·ªã kh√≥a:**
```json
{
  "statusCode": 403,
  "message": "ACCOUNT_SUSPENDED",
  "data": null
}
```

**Response 403 - T√†i kho·∫£n ch∆∞a k√≠ch ho·∫°t:**
```json
{
  "statusCode": 403,
  "message": "ACCOUNT_INACTIVE",
  "data": null
}
```

**Validation Errors:**
- `EMAIL_REQUIRED` - Email l√† b·∫Øt bu·ªôc
- `INVALID_EMAIL_FORMAT` - ƒê·ªãnh d·∫°ng email kh√¥ng h·ª£p l·ªá
- `PASSWORD_REQUIRED` - M·∫≠t kh·∫©u l√† b·∫Øt bu·ªôc

---

### 2. üìù ƒêƒÉng k√Ω - POST `/register`

**M√¥ t·∫£:** T·∫°o t√†i kho·∫£n ng∆∞·ªùi d√πng m·ªõi trong h·ªá th·ªëng.

**Request Body:**
```json
{
  "email": "newuser@example.com",
  "password": "SecureP@ss123",
  "confirmPassword": "SecureP@ss123",
  "firstName": "Nguyen",
  "lastName": "Van B"
}
```

**Request Schema:**
| Field | Type | Required | Validation |
|-------|------|----------|------------|
| email | string | ‚úÖ | Email format, max 100 chars |
| password | string | ‚úÖ | Min 8 chars, uppercase + lowercase + number + special char |
| confirmPassword | string | ‚úÖ | Ph·∫£i tr√πng v·ªõi password |
| firstName | string | ‚úÖ | Max 50 chars |
| lastName | string | ‚úÖ | Max 50 chars |

**Response 201 - Th√†nh c√¥ng:**
```json
{
  "statusCode": 201,
  "message": "REGISTRATION_SUCCESS",
  "data": {
    "userId": 5,
    "email": "newuser@example.com",
    "firstName": "Nguyen",
    "lastName": "Van B",
    "role": "User",
    "status": "Active",
    "createdAt": "2025-01-17T10:30:00Z"
  }
}
```

**Response 409 - Email ƒë√£ t·ªìn t·∫°i:**
```json
{
  "statusCode": 409,
  "message": "EMAIL_ALREADY_EXISTS",
  "data": null
}
```

**Validation Errors:**
- `EMAIL_REQUIRED` - Email l√† b·∫Øt bu·ªôc
- `INVALID_EMAIL_FORMAT` - Email kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng
- `PASSWORD_REQUIRED` - Password l√† b·∫Øt bu·ªôc
- `PASSWORD_MIN_8_CHARACTERS` - Password t·ªëi thi·ªÉu 8 k√Ω t·ª±
- `PASSWORD_MUST_CONTAIN_UPPERCASE_LOWERCASE_NUMBER_SPECIAL` - Password ph·∫£i c√≥ ch·ªØ hoa, ch·ªØ th∆∞·ªùng, s·ªë v√† k√Ω t·ª± ƒë·∫∑c bi·ªát
- `CONFIRM_PASSWORD_MUST_MATCH` - Confirm password kh√¥ng kh·ªõp
- `FIRST_NAME_REQUIRED` - T√™n l√† b·∫Øt bu·ªôc
- `LAST_NAME_REQUIRED` - H·ªç l√† b·∫Øt bu·ªôc

**Quy t·∫Øc Password:**
- T·ªëi thi·ªÉu 8 k√Ω t·ª±
- √çt nh·∫•t 1 ch·ªØ HOA (A-Z)
- √çt nh·∫•t 1 ch·ªØ th∆∞·ªùng (a-z)
- √çt nh·∫•t 1 s·ªë (0-9)
- √çt nh·∫•t 1 k√Ω t·ª± ƒë·∫∑c bi·ªát (@$!%*?&)

---

### 3. üîÑ L√†m m·ªõi Token - POST `/refresh-token`

**M√¥ t·∫£:** S·ª≠ d·ª•ng refresh token ƒë·ªÉ l·∫•y access token m·ªõi khi token c≈© h·∫øt h·∫°n.

**Request Body:**
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Request Schema:**
| Field | Type | Required | Validation |
|-------|------|----------|------------|
| refreshToken | string | ‚úÖ | JWT format |

**Response 200 - Th√†nh c√¥ng:**
```json
{
  "statusCode": 200,
  "message": "TOKEN_REFRESH_SUCCESS",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 3600
  }
}
```

**Response 401 - Refresh token kh√¥ng h·ª£p l·ªá:**
```json
{
  "statusCode": 401,
  "message": "INVALID_OR_EXPIRED_REFRESH_TOKEN",
  "data": null
}
```

**Response 404 - Kh√¥ng t√¨m th·∫•y user:**
```json
{
  "statusCode": 404,
  "message": "USER_NOT_FOUND",
  "data": null
}
```

**Response 403 - T√†i kho·∫£n b·ªã kh√≥a:**
```json
{
  "statusCode": 403,
  "message": "ACCOUNT_SUSPENDED",
  "data": null
}
```

---

### 4. üîê Qu√™n m·∫≠t kh·∫©u - POST `/forgot-password`

**M√¥ t·∫£:** G·ª≠i m√£ OTP qua email ƒë·ªÉ ng∆∞·ªùi d√πng ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u.

**Request Body:**
```json
{
  "email": "user@example.com"
}
```

**Request Schema:**
| Field | Type | Required | Validation |
|-------|------|----------|------------|
| email | string | ‚úÖ | Email format |

**Response 200 - Th√†nh c√¥ng:**
```json
{
  "statusCode": 200,
  "message": "SUCCESS",
  "data": {
    "email": "user@example.com",
    "message": "OTP has been sent to your email",
    "expiresIn": 600
  }
}
```

**Response 404 - Email kh√¥ng t·ªìn t·∫°i:**
```json
{
  "statusCode": 404,
  "message": "USER_NOT_FOUND",
  "data": null
}
```

**L∆∞u √Ω:**
- OTP c√≥ hi·ªáu l·ª±c 10 ph√∫t
- M·ªói email ch·ªâ c√≥ th·ªÉ nh·∫≠n 1 OTP active t·∫°i m·ªôt th·ªùi ƒëi·ªÉm
- OTP g·ªìm 6 ch·ªØ s·ªë

---

### 5. üîì ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u - PATCH `/reset-password`

**M√¥ t·∫£:** ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u m·ªõi b·∫±ng m√£ OTP ƒë√£ nh·∫≠n qua email.

**Request Body:**
```json
{
  "email": "user@example.com",
  "otp": "123456",
  "newPassword": "NewP@ssw0rd123"
}
```

**Request Schema:**
| Field | Type | Required | Validation |
|-------|------|----------|------------|
| email | string | ‚úÖ | Email format |
| otp | string | ‚úÖ | 6 digits |
| newPassword | string | ‚úÖ | Min 8 chars, uppercase + lowercase + number + special char |

**Response 200 - Th√†nh c√¥ng:**
```json
{
  "statusCode": 200,
  "message": "SUCCESS",
  "data": {
    "email": "user@example.com",
    "message": "Password has been reset successfully"
  }
}
```

**Response 400 - OTP kh√¥ng ƒë√∫ng/h·∫øt h·∫°n:**
```json
{
  "statusCode": 400,
  "message": "INVALID_OR_EXPIRED_OTP",
  "data": null
}
```

**Response 404 - Email kh√¥ng t·ªìn t·∫°i:**
```json
{
  "statusCode": 404,
  "message": "USER_NOT_FOUND",
  "data": null
}
```

**Validation Errors:**
- `EMAIL_REQUIRED` - Email l√† b·∫Øt bu·ªôc
- `INVALID_EMAIL_FORMAT` - Email kh√¥ng h·ª£p l·ªá
- `OTP_MIN_6_CHARACTERS` - OTP ph·∫£i c√≥ 6 k√Ω t·ª±
- `NEW_PASSWORD_MIN_8_CHARACTERS` - Password m·ªõi t·ªëi thi·ªÉu 8 k√Ω t·ª±

---

### 6. ü™™ X√°c minh gi·∫•y ph√©p l√°i xe - POST `/verify-license`

**M√¥ t·∫£:** X√°c minh gi·∫•y ph√©p l√°i xe c∆° b·∫£n th√¥ng qua AuthService (ch·ª©c nƒÉng n√¢ng cao xem `/api/license`).

**Request Body:**
```json
{
  "licenseNumber": "012345678",
  "issueDate": "2020-05-15",
  "firstName": "Nguyen",
  "lastName": "Van A"
}
```

**Request Schema:**
| Field | Type | Required | Validation |
|-------|------|----------|------------|
| licenseNumber | string | ‚úÖ | Valid license format |
| issueDate | string | ‚úÖ | ISO 8601 date format |
| firstName | string | ‚úÖ | Max 50 chars |
| lastName | string | ‚úÖ | Max 50 chars |

**Response 200 - Th√†nh c√¥ng:**
```json
{
  "statusCode": 200,
  "message": "LICENSE_VERIFICATION_SUCCESS",
  "data": {
    "licenseNumber": "012345678",
    "isValid": true,
    "verificationDate": "2025-01-17T10:30:00Z"
  }
}
```

**Response 400 - X√°c minh th·∫•t b·∫°i:**
```json
{
  "statusCode": 400,
  "message": "INVALID_LICENSE_FORMAT",
  "data": null
}
```

**Response 409 - Gi·∫•y ph√©p ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω:**
```json
{
  "statusCode": 409,
  "message": "LICENSE_ALREADY_REGISTERED",
  "data": null
}
```

**Validation Errors:**
- `LICENSE_NUMBER_REQUIRED` - S·ªë gi·∫•y ph√©p l√† b·∫Øt bu·ªôc
- `INVALID_LICENSE_FORMAT` - ƒê·ªãnh d·∫°ng s·ªë gi·∫•y ph√©p kh√¥ng h·ª£p l·ªá
- `ISSUE_DATE_REQUIRED` - Ng√†y c·∫•p l√† b·∫Øt bu·ªôc
- `FIRST_NAME_REQUIRED` - T√™n l√† b·∫Øt bu·ªôc
- `LAST_NAME_REQUIRED` - H·ªç l√† b·∫Øt bu·ªôc

---

### 7. üß™ [Development] L·∫•y OTP Test - GET `/test/get-forgot-password-otp`

**M√¥ t·∫£:** Endpoint test ƒë·ªÉ l·∫•y OTP ƒë√£ t·∫°o (ch·ªâ d√πng trong m√¥i tr∆∞·ªùng development).

**Query Parameters:**
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| email | string | ‚úÖ | Email ƒë√£ request OTP |

**Request:**
```http
GET /api/auth/test/get-forgot-password-otp?email=user@example.com
```

**Response 200 - C√≥ OTP:**
```json
{
  "statusCode": 200,
  "message": "SUCCESS",
  "data": {
    "email": "user@example.com",
    "otp": "123456",
    "createdAt": "2025-01-17T10:30:00Z",
    "expiresAt": "2025-01-17T10:40:00Z"
  }
}
```

**Response 404 - Kh√¥ng c√≥ OTP:**
```json
{
  "statusCode": 404,
  "message": "OTP_NOT_FOUND",
  "data": null
}
```

**‚ö†Ô∏è L∆∞u √Ω:** Endpoint n√†y ch·ªâ ho·∫°t ƒë·ªông trong m√¥i tr∆∞·ªùng Development, s·∫Ω b·ªã v√¥ hi·ªáu h√≥a trong Production.

---

## üî¢ Enums v√† Constants

### User Role (EUserRole)
```typescript
enum EUserRole {
  Admin = 0,      // Qu·∫£n tr·ªã vi√™n
  Staff = 1,      // Nh√¢n vi√™n
  CoOwner = 2,    // ƒê·ªìng s·ªü h·ªØu (c√≥ th·ªÉ t·∫°o/tham gia nh√≥m xe)
  User = 3        // Ng∆∞·ªùi d√πng th∆∞·ªùng (ch∆∞a l√† co-owner)
}
```

### User Status (EUserStatus)
```typescript
enum EUserStatus {
  Active = 0,     // T√†i kho·∫£n ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
  Inactive = 1,   // T√†i kho·∫£n ch∆∞a k√≠ch ho·∫°t
  Suspended = 2   // T√†i kho·∫£n b·ªã kh√≥a/ƒë√¨nh ch·ªâ
}
```

---

## ‚ùå Error Codes

### Authentication Errors (4xx)
| Status | Code | Message | √ù nghƒ©a |
|--------|------|---------|---------|
| 400 | Bad Request | `INVALID_EMAIL_OR_PASSWORD` | Email ho·∫∑c password sai |
| 401 | Unauthorized | `INVALID_TOKEN` | Token kh√¥ng h·ª£p l·ªá |
| 401 | Unauthorized | `INVALID_OR_EXPIRED_REFRESH_TOKEN` | Refresh token h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá |
| 403 | Forbidden | `ACCOUNT_SUSPENDED` | T√†i kho·∫£n b·ªã kh√≥a |
| 403 | Forbidden | `ACCOUNT_INACTIVE` | T√†i kho·∫£n ch∆∞a k√≠ch ho·∫°t |
| 404 | Not Found | `USER_NOT_FOUND` | Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng |
| 409 | Conflict | `EMAIL_ALREADY_EXISTS` | Email ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω |
| 409 | Conflict | `LICENSE_ALREADY_REGISTERED` | Gi·∫•y ph√©p ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω |

### Validation Errors (400)
| Code | √ù nghƒ©a |
|------|---------|
| `EMAIL_REQUIRED` | Email l√† b·∫Øt bu·ªôc |
| `INVALID_EMAIL_FORMAT` | Email kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng |
| `PASSWORD_REQUIRED` | Password l√† b·∫Øt bu·ªôc |
| `PASSWORD_MIN_8_CHARACTERS` | Password t·ªëi thi·ªÉu 8 k√Ω t·ª± |
| `PASSWORD_MUST_CONTAIN_UPPERCASE_LOWERCASE_NUMBER_SPECIAL` | Password ph·∫£i c√≥ ch·ªØ hoa, th∆∞·ªùng, s·ªë v√† k√Ω t·ª± ƒë·∫∑c bi·ªát |
| `CONFIRM_PASSWORD_MUST_MATCH` | Confirm password kh√¥ng kh·ªõp |
| `FIRST_NAME_REQUIRED` | T√™n l√† b·∫Øt bu·ªôc |
| `LAST_NAME_REQUIRED` | H·ªç l√† b·∫Øt bu·ªôc |

### System Errors (5xx)
| Status | Code | √ù nghƒ©a |
|--------|------|---------|
| 500 | Internal Server Error | `INTERNAL_SERVER_ERROR` | L·ªói h·ªá th·ªëng |

---

## üí° V√≠ d·ª• s·ª≠ d·ª•ng

### Use Case 1: Flow ƒëƒÉng k√Ω v√† ƒëƒÉng nh·∫≠p ho√†n ch·ªânh

```javascript
// 1. ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi
const registerResponse = await fetch('http://localhost:5215/api/auth/register', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    email: 'newuser@example.com',
    password: 'SecureP@ss123',
    confirmPassword: 'SecureP@ss123',
    firstName: 'Nguyen',
    lastName: 'Van B'
  })
});

const registerData = await registerResponse.json();
console.log('User ID:', registerData.data.userId);

// 2. ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n v·ª´a t·∫°o
const loginResponse = await fetch('http://localhost:5215/api/auth/login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    email: 'newuser@example.com',
    password: 'SecureP@ss123'
  })
});

const loginData = await loginResponse.json();
const accessToken = loginData.data.accessToken;
const refreshToken = loginData.data.refreshToken;

// 3. S·ª≠ d·ª•ng access token ƒë·ªÉ g·ªçi API kh√°c
const profileResponse = await fetch('http://localhost:5215/api/profile', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${accessToken}`
  }
});

const profileData = await profileResponse.json();
console.log('Profile:', profileData);
```

### Use Case 2: X·ª≠ l√Ω token h·∫øt h·∫°n v·ªõi Refresh Token

```javascript
let accessToken = 'current_access_token';
let refreshToken = 'current_refresh_token';

async function callApiWithTokenRefresh(url, options = {}) {
  // Th·ª≠ g·ªçi API v·ªõi access token hi·ªán t·∫°i
  let response = await fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      'Authorization': `Bearer ${accessToken}`
    }
  });

  // N·∫øu token h·∫øt h·∫°n (401), refresh token
  if (response.status === 401) {
    console.log('Access token expired, refreshing...');
    
    const refreshResponse = await fetch('http://localhost:5215/api/auth/refresh-token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        refreshToken: refreshToken
      })
    });

    if (refreshResponse.ok) {
      const refreshData = await refreshResponse.json();
      accessToken = refreshData.data.accessToken;
      refreshToken = refreshData.data.refreshToken;

      // L∆∞u token m·ªõi v√†o localStorage
      localStorage.setItem('accessToken', accessToken);
      localStorage.setItem('refreshToken', refreshToken);

      // Th·ª≠ l·∫°i request v·ªõi token m·ªõi
      response = await fetch(url, {
        ...options,
        headers: {
          ...options.headers,
          'Authorization': `Bearer ${accessToken}`
        }
      });
    } else {
      // Refresh token c≈©ng h·∫øt h·∫°n, redirect v·ªÅ login
      window.location.href = '/login';
      throw new Error('Session expired, please login again');
    }
  }

  return response;
}

// S·ª≠ d·ª•ng
const data = await callApiWithTokenRefresh('http://localhost:5215/api/vehicle/available');
```

### Use Case 3: Flow qu√™n m·∫≠t kh·∫©u v√† ƒë·∫∑t l·∫°i

```javascript
// 1. Ng∆∞·ªùi d√πng qu√™n m·∫≠t kh·∫©u, request OTP
const forgotResponse = await fetch('http://localhost:5215/api/auth/forgot-password', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    email: 'user@example.com'
  })
});

const forgotData = await forgotResponse.json();
console.log(forgotData.data.message); // "OTP has been sent to your email"

// 2. [Development only] L·∫•y OTP ƒë·ªÉ test
const otpResponse = await fetch('http://localhost:5215/api/auth/test/get-forgot-password-otp?email=user@example.com');
const otpData = await otpResponse.json();
const otp = otpData.data.otp; // "123456"

// 3. Ng∆∞·ªùi d√πng nh·∫≠p OTP v√† m·∫≠t kh·∫©u m·ªõi
const resetResponse = await fetch('http://localhost:5215/api/auth/reset-password', {
  method: 'PATCH',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    email: 'user@example.com',
    otp: otp,
    newPassword: 'NewSecureP@ss456'
  })
});

const resetData = await resetResponse.json();
console.log(resetData.data.message); // "Password has been reset successfully"

// 4. ƒêƒÉng nh·∫≠p v·ªõi m·∫≠t kh·∫©u m·ªõi
const loginResponse = await fetch('http://localhost:5215/api/auth/login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    email: 'user@example.com',
    password: 'NewSecureP@ss456'
  })
});
```

### Use Case 4: X√°c minh gi·∫•y ph√©p l√°i xe khi ƒëƒÉng k√Ω

```javascript
// Sau khi ƒëƒÉng k√Ω th√†nh c√¥ng, x√°c minh gi·∫•y ph√©p l√°i xe
const verifyLicenseResponse = await fetch('http://localhost:5215/api/auth/verify-license', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    licenseNumber: '012345678',
    issueDate: '2020-05-15',
    firstName: 'Nguyen',
    lastName: 'Van B'
  })
});

const verifyData = await verifyLicenseResponse.json();

if (verifyData.statusCode === 200) {
  console.log('License verified successfully!');
  // Ng∆∞·ªùi d√πng c√≥ th·ªÉ ti·∫øp t·ª•c ƒëƒÉng k√Ω th√†nh Co-owner
} else if (verifyData.statusCode === 409) {
  console.log('License already registered by another user');
} else {
  console.log('License verification failed:', verifyData.message);
}
```

---

## üîê Best Practices

### 1. L∆∞u tr·ªØ Token an to√†n

```javascript
// ‚úÖ T·ªêT: L∆∞u trong memory/localStorage v·ªõi httpOnly cookie
localStorage.setItem('accessToken', accessToken);
sessionStorage.setItem('refreshToken', refreshToken); // Ho·∫∑c httpOnly cookie

// ‚ùå T·ªÜ: Kh√¥ng l∆∞u token trong code ho·∫∑c URL
const token = 'hardcoded_token_here'; // NEVER DO THIS!
window.location.href = '/dashboard?token=' + token; // NEVER DO THIS!
```

### 2. X·ª≠ l√Ω l·ªói chu·∫©n

```javascript
async function login(email, password) {
  try {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    const data = await response.json();

    switch(data.statusCode) {
      case 200:
        // ƒêƒÉng nh·∫≠p th√†nh c√¥ng
        saveTokens(data.data.accessToken, data.data.refreshToken);
        return { success: true, user: data.data.user };
      
      case 400:
        // Email ho·∫∑c password sai
        return { success: false, error: 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng' };
      
      case 403:
        if (data.message === 'ACCOUNT_SUSPENDED') {
          return { success: false, error: 'T√†i kho·∫£n ƒë√£ b·ªã kh√≥a. Vui l√≤ng li√™n h·ªá admin.' };
        } else if (data.message === 'ACCOUNT_INACTIVE') {
          return { success: false, error: 'T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t. Vui l√≤ng ki·ªÉm tra email.' };
        }
        break;
      
      default:
        return { success: false, error: 'ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.' };
    }
  } catch (error) {
    console.error('Login error:', error);
    return { success: false, error: 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server' };
  }
}
```

### 3. Auto-refresh token tr∆∞·ªõc khi h·∫øt h·∫°n

```javascript
// Ki·ªÉm tra token c√≤n bao l√¢u h·∫øt h·∫°n
function getTokenExpirationTime(token) {
  const payload = JSON.parse(atob(token.split('.')[1]));
  return payload.exp * 1000; // Convert to milliseconds
}

// T·ª± ƒë·ªông refresh token tr∆∞·ªõc 5 ph√∫t khi s·∫Øp h·∫øt h·∫°n
function setupTokenRefresh(accessToken, refreshToken) {
  const expirationTime = getTokenExpirationTime(accessToken);
  const currentTime = Date.now();
  const timeUntilExpiration = expirationTime - currentTime;
  const refreshTime = timeUntilExpiration - (5 * 60 * 1000); // 5 minutes before expiration

  if (refreshTime > 0) {
    setTimeout(async () => {
      const newTokens = await refreshAccessToken(refreshToken);
      if (newTokens) {
        setupTokenRefresh(newTokens.accessToken, newTokens.refreshToken);
      }
    }, refreshTime);
  }
}
```

---

## üìû Li√™n h·ªá v√† H·ªó tr·ª£

- **API Documentation:** http://localhost:5215/swagger
- **Backend Team:** [Your team contact]
- **Issues:** [GitHub Issues URL]

---

**Last Updated:** 2025-01-17  
**Version:** 1.0.0  
**Author:** Backend Development Team
